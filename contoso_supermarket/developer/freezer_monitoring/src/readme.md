# Freezer Monitor

Easy-to-configure MQTT simulator written in [Python 3](https://www.python.org/) to simulate the sending of JSON objects from sensors or devices to a broker.

[Features](#features) •
[Important Notes](#important-notes) •
[Resources](#resources) •
[Tools](#tools) •
[Getting Started](#getting-started) •
[Configuration](#configuration) •
[Authors](#authors)

## Features
Freezer Monitor combines a MQTT broker and MQTT simulator to simulate the sending of JSON objects from sensors or devices to a broker. The simulator can be configured to send messages at a specified interval, and the broker can be configured to send messages to an IoT Hub.

## Important Notes

- Topics are *extremely sensitive* in Azure IoT. For example if you add:

    mqtt-simulator/settings.json: 
        
        "devices/freezer1/messages/events/environmentSensor"
    `
    then you must also add:

    mqtt-broker/ mosquitto.conf:
    
        topic devices/freezer1/messages/events/environmentSensor out 1

- SAS Tokens need to be renewed periodically. Currently, you must run the `az iot hub generate-sas-token` command to get a new token and then update the mosquitto.conf file. This is a manual process that will be automated in the future.

- The simulator is currently configured to send messages to the broker on port 1883. The broker is configured to send messages to the IoT Hub on port 8883. If you change the port in the simulator, you must also change the port in the broker.


## Installing with Helm

`helm install sensor-monitor sensor-monitor --version 1.0.0`

### Upgrade

`helm upgrade sensor-monitor sensor-monitor --version 1.0.1`

### Uninstall

`helm uninstall sensor-monitor`

## Install Additional Prometheus monitoring config

1. Install additional scrape config
```
helm repo update

helm upgrade -n observability prometheus prometheus-community/kube-prometheus-stack -f ./mqtt2prom/prometheus-additional-scrape-config.yaml --set alertmanager.enabled=false,grafana.enabled=false,prometheus.service.type=LoadBalancer,web.enable-lifecycle=true
```

2. you're done - there is no step 2 :)

## Local testing process of the broker and simulator

- get a sas token - expires every 60 minutes by default but can be overridden with the `--duration` parameter

    ```powershell
    ((az iot hub generate-sas-token -g charris-iot1 -d freezer2 --duration $(60*20*24*365) -n charris-iot1 -o json) | convertfrom-json).sas | set-clipboard
    ```

- update the mosquitto.conf file with the new token

    ```bash
    sed -i 's/SharedAccessSignature sr=charris-iot1.azure-devices.net%2Ffreezer2&sig=.*&se=.*&skn=iothubowner/SharedAccessSignature sr=charris-iot1.azure-devices.net%2Ffreezer2&sig=REPLACE_WITH_NEW_TOKEN&se=REPLACE_WITH_NEW_TOKEN&skn=iothubowner/g' mqtt-broker/mosquitto.conf
    ```

- from the freezer_monitoring\src folder

- start the broker
    `docker build -t js/mqtt-broker:latest .\mqtt-broker\.; .\mqtt-broker\Dockerrun.ps1`

- start the simulator
    `docker build -t js/mqtt-simulator:latest .\mqtt-simulator\.; .\mqtt-simulator\Dockerrun.ps1`

- start the mqtt2prom
    `docker build -t js/mqtt2prom:latest .\mqtt2prom\.; .\mqtt2prom\Dockerrun.ps1`

- install mosquitto client
    `apt install mosquitto -y`

- subscribe
    `mosquitto_sub -h localhost -p 1883 -u sensor123 -P sensor123 -v -t freezer/+`
    or http://mqtt-explorer.com/ - connect and then click the little green graph icon next to the value on the right side   

### TODO - Need to test these next two - they were auto-generated by Copilot
- update the mosquitto.conf file with the new device name

    ```bash
    sed -i 's/devices\/freezer2\/messages\/events\/freezer/devices\/freezer2\/messages\/events\/freezer/g' mqtt-broker/mosquitto.conf
    ```
- update the settings.json file with the new device name

    ```bash
    sed -i 's/devices\/freezer2\/messages\/events\/freezer/devices\/freezer2\/messages\/events\/freezer/g' mqtt-simulator/settings.json
    ```


## Cloud testing process

### Test your own messages with `mosquitto_pub`

- Follow one of the [Resources](#resources) links above to get the Baltimore.pem file

    ```shell
    export sas_token=$(az iot hub generate-sas-token -g charris-iot1 -d myEdgeDevice --duration $(60*20*24*365) -n charris-iot1 -o json | jq -r '.sas')

    mosquitto_pub -t "devices/myEdgeDevice/messages/events/environmentSensor" -i "myEdgeDevice" -u "charris-iot1.azure-devices.net/myEdgeDevice/?api-version=2020-09-30" -P $sas_token -h "charris-iot1.azure-devices.net" -V mqttv311 -p 8883 --cafile Baltimore.pem -m 'My Awesome Message' -d
    ```

### View the messages in IoT Hub

- monitor what's coming into IoT hub
    `az iot hub monitor-events --output table --device-id myEdgeDevice --hub-name charris-iot1 --output json`


## Push images to MCR
    ```shell
    docker push jumpstartagora.azurecr.io/contoso-supermarket/mqtt-broker
    docker push jumpstartagora.azurecr.io/contoso-supermarket/mqtt-simulator
    ```

    ### Local AKS EE deployment - All-in-one commands for convenience
    
    ```shell
    docker build -t js/mqtt-broker .\mqtt-broker\.; docker tag js/mqtt-broker jumpstartagora.azurecr.io/contoso-supermarket/mqtt-broker ; docker push jumpstartagora.azurecr.io/contoso-supermarket/mqtt-broker
    
    docker build -t js/mqtt-simulator .\mqtt-simulator\.; docker tag js/mqtt-simulator jumpstartagora.azurecr.io/contoso-supermarket/mqtt-simulator ; docker push jumpstartagora.azurecr.io/contoso-supermarket/mqtt-simulator
    ```


## Azure IoT Setup

1. https://techcommunity.microsoft.com/t5/internet-of-things-blog/mosquitto-client-tools-and-azure-iot-hub-the-beginning-of/ba-p/2824717
2. 
3. Ignore following...
4. `$LOCATION = "eastus"`
5. `$RESOURCE_GROUP_NAME = "charris-js-ag-42-rg"`
6. `$HUB_NAME = "Ag-IotHub-b976e"`
7. `az group create --location $location --name $RESOURCE_GROUP_NAME`
   
8. Create the devices
    
    ```powershell
        $DEVICES = ("freezer-1-chicago","freezer-2-chicago")
        foreach ($DEVICE in $DEVICES) {
            az iot hub device-identity create --device-id $DEVICE --edge-enabled --hub-name $HUB_NAME
        }
    ```
    `az iot hub device-identity create --device-id $DEVICE --edge-enabled --hub-name $HUB_NAME`
9. View connection string
   1. `az iot hub device-identity connection-string show --device-id $DEVICE --hub-name $HUB_NAME -o tsv`
10. Configure Broker to send to IoT Hub
  - foreach device: update remote_password in mqtt-broker/mosquitto.conf
  `az iot hub generate-sas-token --device-id $DEVICE --hub-name $HUB_NAME --duration (60*60*24*365) --query sas -o tsv`


Elevated PowerShell
    1. Install AzureIoTEdge

    ```powershell
    $msiPath = $([io.Path]::Combine($env:TEMP, 'AzureIoTEdge.msi'))
    $ProgressPreference = 'SilentlyContinue'
    Invoke-WebRequest "https://aka.ms/AzEFLOWMSI_1_4_LTS_X64" -OutFile $msiPath
    Start-Process -Wait msiexec -ArgumentList "/i","$([io.Path]::Combine($env:TEMP, 'AzureIoTEdge.msi'))","/qn"
    ```

# Troubleshooting tips

1. To restart Prometheus and have it reload it's config

    `curl -Method POST 172.20.1.31:9090/-/reload`

2. To install nano in a container

    `apt-get update && apt-get install nano`

3. To manually update a configmap after changing a local config file for testing

    `kubectl create configmap mqtt-broker-config --from-file=$mqttbrokerConfigPath --dry-run=client -o yaml | kubectl apply -f -`

## Resources

- [Mosquitto MQTT broker to IoT Hub/IoT Edge](http://busbyland.com/mosquitto-mqtt-broker-to-iot-hub-iot-edge/)
- https://mosquitto.org/man/mosquitto-conf-5.html
- [Quickstart creates an Azure IoT Edge device on Linux | Microsoft Learn](https://learn.microsoft.com/azure/iot-edge/quickstart-linux?view=iotedge-1.4&viewFallbackFrom=iotedge-2020-11)
- [Quickstart - Send telemetry to Azure IoT Hub (CLI) quickstart | Microsoft Learn](https://learn.microsoft.com/azure/iot-hub/quickstart-send-telemetry-cli)

## Tools
- [IoT Explorer](https://github.com/Azure/azure-iot-explorer/releases)
    
    Lets you explore devices and their messages in Azure IoT Hub.
    However, you may not see messages in the Explorer if you are forwarding your messages to Azure Data Explorer (ADX) or Azure Event Hubs (AEH).

- [MQTT Explorer](http://mqtt-explorer.com/)
    
    Lets you explore devices and their messages in a local MQTT broker.

